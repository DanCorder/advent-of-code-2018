namespace advent_of_code_2018
{
    using System;
    using System.Linq;
    using System.Collections.Generic;

    public class Day13
    {
        private const string ProblemInput = @"   /----------------------------------------------------------------------------------------------\                                                   x
   |        /-----------------------------------------------------\                               |                                                   x
   |     /--+-----------------------------------------------------+-------------------------------+--\                            /---------\         x
 /-+-----+--+-------------------------------------------------\   |                               |  |                            |         |         x
 | |     |  |     /-------------------------------------------+---+--------------------------\    |  |                            |         |         x
 | |     |  |    /+---------------\                           |   |            /-------------+----+--+----------------------------+-------\ |         x
 | |     |  |    ||               |                      /----+---+------------+\            |    |  |                            |       | |         x
 | |     |  |    ||               |                      |    |   |        /---++------------+----+--+-----------------\          |       | |         x
 | |     |  |    ||               |                      |    |   |        |   ||  /---------+----+--+-----------------+---------\|       | |         x
 | |     |  |    ||               |                      |   /+---+--------+---++--+---------+----+--+----------\      |         ||       | |         x
 | |     |  |    ||        /------+----------------------+-\ ||   |        |   ||  |         |    |  |          |      |         ||       | |         x
 | |     |  |    ||        |      |                      | | ||  /+--------+---++--+---------+--\ |  |          |      |         ||       | |         x
 | |     |  |    ||        |     /+----------------------+-+-++--++--------+---++--+---------+--+-+--+----------+------+-----\   ||       | |         x
 | |     |  |    ||       /+-----++----------------------+-+-++--++--------+---++--+---------+--+-+--+------\   |      |     |   ||       | |         x
 | |     |  |    ||       ||     ||                      | | ||  ||        |   ||  |         |  | |  |    /-+---+------+-----+---++\      | |         x
 | |  /--+--+----++--<----++-----++------------\         | | ||  ||        |   ||  |         |  | |  |    | |  /+------+-----+---+++---\  | |         x
 | |  |  |  |   /++-------++-----++--\         |      /--+-+-++--++--------+---++--+---------+--+-+--+----+-+--++------+-----+---+++---+--+-+--\      x
 | |  |  |  |   |||  /----++-----++--+---------+----\ |  | | ||  ||        \---++--+---------+--+-+--+----+-+--++------/     |   |||   |  | |  |      x
 | \--+--+--+---+++--+----++-----++--+---------+----+-+--+-+-++--++------------++--+---------+--+-/  |    | |  ||            |   |||   |  | |  |      x
 |    |  |  |   |||  |    ||     ||  |       /-+----+-+--+-+-++--++------------++--+---------+--+----+----+-+--++------------+---+++-\ |  | |  |      x
 |  /-+--+--+---+++--+----++----\||  |       | |    | |  | | ||  ||            ||  |         |  |    |    | |  ||            |   ||| | |  | |  |      x
 |/-+-+--+--+---+++--+----++----+++--+-------+-+----+-+--+-+-++--++------------++\ |         |  |    |    | |  ||            |   |\+-+-+--+-/  |      x
 || | |  |  |   |||  |    ||  /-+++--+-------+-+----+-+--+-+-++--++------------+++-+---------+--+----+----+-+--++------------+-<\| | | |  |    |      x
 || | |  |  |   |||  |    ||  | |||  |       |/+----+-+--+-+-++--++------------+++-+---------+--+----+---\| |  ||            |  || | | |  |    |      x
 || | |  |  |   |||  |    ||  | |||  |       |||/---+-+--+-+-++--++--------\ /-+++-+---------+--+----+---++-+--++------------+--++-+-+-+--+----+-\    x
 || | |  |  |/--+++--+----++--+-+++--+-------++++---+-+--+-+-++--++--------+-+-+++-+---------+--+----+---++-+--++\           |  || | | |  |    | |    x
 || | |  |  ||  |||  |    ||  | |||  |       ||||   | | /+-+-++--++--------+-+-+++-+---------+--+----+---++-+--+++--------\  |  || | | |  |    | |    x
 || | |  |  ||  |||  |    ||  | |||  |       ||||/--+-+-++-+-++--++--------+-+-+++-+---------+--+----+---++-+--+++--------+\ |  || | | |  |    | |    x
 || | |  |  ||  ||| /+----++--+-+++--+-------+++++--+-+-++\| ||  ||        | | \++-+---------+--+----+---++-+--+++--------++-+--++-+-+-+--/    | |    x
 || | |  |  ||  ||| || /--++--+-+++--+-------+++++\ | | |||| ||  ||       /+-+--++-+---------+--+----+---++-+--+++--------++-+--++-+-+-+-----\ | |    x
 || | |  |  ||  ||| || |  ||  | |||  |       |||||| | | |||| || /++-------++-+--++-+----\/---+--+----+---++-+--+++--------++-+--++-+-+-+\    | | |    x
 || | \--+--++--+++-++-+--++--+-+++--+-------++/||| | | ||||/++-+++-------++-+--++-+----++---+--+----+---++-+--+++--------++-+--++-+-+-++----+-+-+\   x
 || |    |  ||  ||| || |  ||  | |||  |    /--++-+++-+-+-+++++++-+++-------++-+--++\|    ||   |  |  /-+---++-+--+++--------++-+--++-+-+-++----+-+-++\  x
 || |    |  ||  ||| || |  ||  | |||  |/---+--++-+++-+-+-+++++++-+++-------++-+--++++----++---+\ |  | |   || |  |||        || |  |^ | | ||    | | |||  x
 || |    |  || /+++-++-+--++--+-+++--++---+--++-+++-+-+-+++++++-+++-------++-+--++++----++---++-+--+-+---++-+--+++--\     || |  || | | ||    | | |||  x
 || |    | /++-++++-++-+--++--+-+++--++---+--++-+++-+-+-+++++++-+++-------++-+--++++-\  ||   || |  | |/->++-+--+++--+--\  || |  || | | v|    | | |||  x
 || |    |/+++-++++-++-+--++\ | |||  ||   |  || ||| | | |||||\+-+++-------++-+--++++-+--++---++-+--+-++--++-+--+/|  |  |  || |  || | | ||    | | |||  x
 || |    |||\+-++++-++-+--+++-+-+++--++---+--++-+++-+-+-+++++-+-++/ /-----++-+--++++-+--++---++-+\ | ||  || |  \-+--+--+--++-+--++-+-+-/|    | | |||  x
 || |    ||| | |||| || |  ||| | |||  ||   |  || |||/+-+-+++++-+-++--+-----++-+--++++-+--++---++-++-+-++--++-+\   |  | /+--++-+--++-+\|  |    | | |||  x
 || |    ||| | |||| || |  ||| | |||  ||   |  || ||||| | ||||| | ||  |     || |  |||| |  ||   || || | ||  || ||   |  | ||  || |  || |||  |    | | |||  x
 || |    ||| | |||| || |  ||| | |||  || /-+--++-+++++-+-+++++-+-++--+-----++-+--++++-+--++---++-++-+-++--++-++\  |  | ||  || |  || |||  |    | | |||  x
 |\-+----+++-+-++++-++-+--+++-+-+++--++-+-+--++-+++++-+-+++++-+-++--+-----++-+--+/|| |  ||   || || | ||  || |||  |  | ||  || |  || |||  |    | | |||  x
 |  |    ||| | |||| || |  ||| | |||  || | |  || ||||| | ||||| | ||  |     || |  | || |  ||   || || | ||  || |||  |  | ||  || |  || |||  |    | | |||  x
 |  |    ||| | |||| || |  ||| | |||  || | |  || ||||| | ||||| | ||  |     || |  | || |  ||   || || | ||  || |||  |  | ||  || |  || |||  |    | | |||  x
 |  |    ||| | |||| || |  ||| | |||/-++-+-+--++-+++++-+-+++++-+-++--+-----++-+--+-++-+--++---++-++-+-++--++-+++--+--+-++--++-+\ || |||  |    | | |||  x
 |  |    ||| | |||| || |  ||| | |||| || | |  || ||||| |/+++++-+-++--+-----++-+--+-++-+--++\  || || | ||  ||/+++--+--+-++--++-++-++-+++--+\   | | |||  x
 |  |    ||| | |||| || |  ||| | |||| || | |  || ||||| ||||||| |/++--+-----++-+--+-++-+--+++--++-++-+-++--++++++--+--+-++--++\|| || |||  ||   | | |||  x
 |  |   /+++-+-++++-++-+--+++-+-++++-++-+-+--++-+++++-+++++++-++++--+-----++-+--+-++-+--+++--++-++-+-++--++++++\ |  | ||  ||||| || |||  ||   | | |||  x
 |  |   |||| | |||| || |  ||| | |||| || | |  || ||||| ||||||| ||||  |     || |  | || |  |||  || || | ||  ||||||| |  | ||  ||||| || |||  ||   | | |||  x
 |  |   |||| | |||| || |  ||| | |||| |\-+-+--++-+++++-+++++++-++++--+-----++-+--+-++-+--+++--+/ || |/++--+++++++-+--+-++--+++++-++\|||  ||   | | |||  x
 |  |   |||| | |||| || \--+++-+-++++-+--+-+--++-++/|| ||||||| ||||  |     || |  | || |  |||  |  || |||\--+++++++-+--+-+/  ||||| ||||||  ||   | | |||  x
 |  |   |||| | |||| ||    ||| | |||| |/-+-+--++-++-++-+++++++-++++--+-----++-+--+-++-+--+++--+--++-+++--\||||||| |  | |   ||||| ||||||  ||   | | |||  x
 |  |   |||| | |||| ||    ||| |/++++-++-+-+\ || || || ||\++++-++++--+-----++-+--+-++-+--+++--+--++-+++--++++++++-+--+-+---/|||| ||||||  ||   | | |||  x
 |  |   |||| | \+++-++----+++-++++++-++-+-++-++-++-++-++-++++-++++--+-----++-+--+-++-+--+++--+--++-+++--++++++++-+--/ |    |||| ||||||  ||   | | |||  x
/+--+---++++-+--+++-++----+++-++++++-++-+-++-++-++-++-++-++++-++++--+---\ || | /+-++-+--+++--+--++-+++--++++++++-+----+----++++-++++++--++-\ | | |||  x
||  |   |||| |  ||| ||    ||| |||||| || | ||/++-++-++-++-++++-++++--+---+-++-+-++-++-+--+++--+--++-+++--++++++++-+--\ |    |||| ||||||  || | | | |||  x
||  |   |||| v  ||| ||    ||| |||||| || | ||||| || || || |||| |||| /+---+-++-+-++-++-+--+++--+--++-+++--++++++++-+--+-+----++++-++++++--++-+-+-+-+++\ x
||  |   |||| |  ||\-++----+++-++++++-++-+-+++++-++-++-++-++++-++++-++---+-++-+-++-++-+--+++--/  || |||  |||||||| |  | |    |||| ||||||  || | | | |||| x
||  |   |||| |  ||  |\----+++-++++++-++-+-+++++-++-+/ || |||| |||| |\---+-++-+-++-++-+--+++-----+/ |||  |||||||| |  | |    |||| ||||||  || | | | |||| x
||  |   |||| |  ||  | /---+++-++++++-++-+-+++++-++-+--++-++++-++++-+----+-++-+-++-++-+--+++-----+--+++--++++++++-+-\| |    |||| ||||||  || | | | |||| x
||  |   |||| |  ||  | |   ||| |||||| ||/+-+++++-++-+--++-++++-++++-+----+-++-+-++-++-+--+++---<-+\ |||  |||||||| | || |    |||| ||||||  || | | | |||| x
||  |   |||| |  ||  | |   ||| |||||| |||| \++++-++-+--++-++++-++++-+----+-++-+-++-/| | /+++-----++-+++--++++++++-+-++-+----++++-++++++--++\| | | |||| x
||  |   \+++-+--++--+-+---+++-++++++-++++--++++-++-+--++-++++-++++-+----+-++-+-++--+-+-++++-----++-+++--+++++++/ | || |    |||| ||||||  |||| | | |||| x
||  |/---+++-+--++--+-+---+++-++++++-++++--++++-++-+--++-++++-++++\|    | || | ||  | | ||||     || |||  |||||||  | || |    |||| ||||||  |||| | | |||| x
||  ||   ||| |  ||  | |   ||| |||||| |||| /++++-++-+--++-++++-++++++----+-++\|/++--+-+-++++---\ || |||  ||||||| /+-++-+----++++-++++++\ |||| | | |||| x
||  ||   ||| |  ||  | |   ||| |\++++-++++-+/||| || |  || |||| ||||||    | |||||||  | | ||||   | || |||  ||||||| || || |    |||| ||||||| |||| | | |||| x
||  ||   |||/+--++--+\|   ||| | |||| |||| | ||| || |  || |||| |||\++----+-+++++++--+-+-++++---+-/| \++--+++++++-++-++-+----++++-+++++++-++++-+-+-++/| x
||  ||   |||||  ||  |||   ||| | |||| |||| | ||| |\-+--++-++++-+++-++----+-+++++++--+-+-++++---+--+--++--+++++++-++-++-+----/||| ||||||| |||| | | || | x
||  ||   |||||  ||  |||   ||| | |||| |||| | ||| |  |  |\-++++-+++-++----+-+++++++--+-+-+++/   |  |  ||  ||||||| || || |     ||| ||||||| |||| | | || | x
||  ||   |||||  ||  |||   ||| | |||| |||| | ||| |  |  |  |||| ||| ||    | |||\+++--+-+-+++----+--+--++--+++++++-++-++-+-----+++-+++++++-++++-+-+-/| | x
||  ||   |||||  ||  |||   ||| | |||| |||| | |||/+--+--+--++++-+++-++----+-+++-+++--+-+-+++----+--+--++--+++++++-++-++-+-----+++-+++++++-++++-+-+--+-+\x
||  ||   |||||  ||  |||  /+++-+-++++-++++-+-+++++--+--+--++++-+++-++----+-+++-+++->+-+-+++----+--+--++--+++++++-++-++-+-----+++\||||||| |||| | |  | ||x
||  ||   |||||  ||  ||\--++++-+-++++-++++-+-+++++--+--+--++++-+++-++----+-+++-+++--+-+-+++----+--+--++--+++++++-++-/| |     ||||||||||| |||| | |  | ||x
||  ||   |||||  ||  ||   |||| | |||| |||| | |\+++--+--+--++++-+++-++----+-+++-+++--+-+>+++----+--+--++--+++++++-++--+-+-----+++++++++/| |||| | |  | ||x
||  ||   |||||  ||  ||   |||| |/++++-++++-+-+-+++--+--+--++++\||| || /--+-+++-+++--+-+-+++----+--+--++--+++++++-++-\| |     ||||||||| | |||| | |  | ||x
||  ||   |||||  ||  ||   |\++-++++++-++++-+-+-+++--+--+--++++++++-++-+--+-+++-+++--+-+-+++----+--+--++--++++/|| || || |     ||||||||| | |||| | |  | ||x
||  ||   |||||  || /++---+-++-++++++\|||| | | |||  | /+--++++++++-++-+--+-+++-+++--+-+-+++----+--+--++--++++-++-++-++-+-----+++++++++-+-++++-+-+--+\||x
||  ||   |||||  || |||   | || ||||||||||| | | |||  | ||  \+++++++-++-+--+-+++-++/  | | |||    |  |  ||  |||| || || || |     ||||||||| | |||| | |  ||||x
|\--++---+++++--++-+++---+-++-+++++++++++-+-+-+++--+-++---++++/|| || |  | ||| ||   | | |||    |  |  ||  |||| || ^| || |     ||||||||| | |||| | |  ||||x
|   ||   |||||  || |||   | || ||||||||||| \-+-+++--+-++---++++-++-++-+--+-++/ ||   | | |||    |  |  ||  |||| || || || |     ||||||||| | |||| | |  ||||x
|   ||   |||||  || |||   | || |||||||||||  /+-+++--+-++---++++-++-++-+--+-++--++---+-+-+++----+--+--++--++++-++-++-++-+-----+++++++++-+-++++-+-+\ ||||x
|   ||   |||||  || |||  /+-++-+++++++++++--++-+++--+-++---++++-++-++-+--+-++--++\  | | |||    |  |  ||  |||| || || || |     ||||||||| | |||| | || ||||x
|   ||   |||||  || |||  || || |||||||||||  || |||  | ||   |||| || || |  | ||  |||  | | |||    |  |  ||  |||| || || || |     ||||||||| | |||| | || ||||x
|   ||   |||||  || |||  || || |||||||||||  || |||  | |\---++++-++-++-+--+-++--+++--+-+-+++----+--+--++--++++-++-++-++-+-----+++++++++-+-++++-+-/| ||||x
|   ||   |||||  || |||  || || |||||||||||  || |||  | |    |||| || || |  | ||  |||  | | |||    |  |  ||  ||\+-++-++-++-+-----+++++++/| | |||| |  | ||||x
|   ||   |||||  || |||  || || |||||||||||  || |||  | |    |||| || || |  | ||  |||  | | |||    |  |  ||  || | || || || |     ||||||| | | |||| |  | ||||x
|   ||   |||||  || |||  || || |||||||||||  || |||  | |    |||| || || |  | ||  |||  | | ||\----+--+--++--++-+-++-++-++-+-----+++++++-+-+-/||| |  | ||||x
|   ||   |||||  || |||  || || \++++++++++--++-+++--+-+----++++-++-++-+--+-++--+++--+-+-++-----+--+--++--++-+-++-++-++-+-----++++/|| | |  ||| |  | ||||x
|   ||   |||||  || |||  || ||  ||||||||||  || |||  | |    |||| || |\-+--+-++--+++--+-+-++-----+--+--++--++-+-++-++-++-+-----++++-++-+-+--+++-+--+-++/|x
|   ||   |||||  |\-+++--++-++--+++/||||||  || |||  | |    |||| || |  |  | ||  |\+--+-+-++-----+--+--++--++-+-++-++-++-+-----++++-++-+-+--++/ |  | || |x
|   |\---+++++--+--+++--++-++--+++-++++++--++-+++--+-+----++++-++-/  |  | ||  | |  | | || /---+--+--++--++-+-++-++-++-+--\  |||| || | |  ||  |  | || |x
|   |    |||||  |  |||  || ||  ||| ||||\+--++-+++--+-+----++++-++----+--+-++--+-+--+-+-++-+---+--/  ||  || | || || || |  |  |||| || | |  ||  |  | || |x
|   |  /-+++++->+--+++--++-++--+++-++++-+--++-+++--+-+----++++-++----+--+-++--+-+--+-+-++-+---+-----++--++-+-++\|| || |  |  |||| || | |  ||  |  | || |x
| /-+--+-+++++--+--+++--++-++--+++-++++-+--++-+++--+-+----++++-++----+--+-++--+-+--+-+-++-+---+-----++--++-+\||||| || |  |  |||| || | |  ||  |  | || |x
| | |  | |||||  |  |||  || ||  ||| |||| |  || |||  | |    |||| ||    |  | ||  | |  | | || |   |     ||  || ||||||| || |  |  |||| |v | |  ||  |  | || |x
| | |  | |||||  |  |||  || ||  ||| |||| |  || |||  | |  />++++-++----+--+-++--+-+\ \-+-++-+---+-----++--++-+++++++-++-+--+--++++-/| | |  ||  |  | || |x
| | |  | |||||  |  |||  || ||  ||| |||| |  || |||  | |  | |||| ||/---+--+-++--+-++---+-++-+---+-----++--++\||||||| || |  |  ||||  | | |  ||  |  | || |x
| | |  | ||||\--+--+++--++-++--+++-++++-+--++-+++--+-+--+-++++-+++---+--+-++--+-++---+-++-+---+-----++--+++++++++/ || |  |  ||||  | | |  ||  |  | || |x
| | |  | ||||   |  |||  || ||  ||| |||| |  || |||  | |  | |||| |||   |  | ||  | ||   | ||/+---+-----++\ |||||||||  || |  |  ||||  | | |  ||  |  | || |x
| | |  | ||||   |  |||  || ||  ||| |||| |  || |||  | |  | |||| |||   |  | ||  | ||   |/++++---+----\||| |||||||||  || |  |  ||||  | | |  ||  |  | || |x
| | |  | ||||   |  |||  || ||  ||| |||| |  || |||  | |/-+-++++-+++---+--+-++--+-++---++++++---+----++++-+++++++++--++-+--+--++++--+-+-+--++--+\ | || |x
| | |  | ||||   |  |||  || ||/-+++-++++-+--++-+++--+-++-+-++++-+++---+--+-++--+-++---++++++\  |    |||| |||||||||  || |  |  ||||  | | |  ||  || | || |x
| | |/-+-++++---+--+++--++-+++-+++-++++-+--++-+++--+-++-+-++++-+++---+--+-++--+-++---+++++++--+--\ |||| |||||||||  || |  |  ||||  | | |  ||  || | || |x
| | || |/++++---+--+++--++-+++-+++-++++-+-\|| |||  | || | |||| \++---+--+-++--+-++---+++++++--+--+-++++-+++++++++--++-+--+--/|||  | | |  ||  || | || |x
| | || ||||\+---+--+++--++-+++-+++-++++-+-+++-+++--+-++-+-++++--++---+--+-++--+-++---/||||||  | /+-++++-+++++++++--++\|  |   |||  | | |  ||  || | || |x
| | || |||| |/--+--+++-\|| ||| ||| |||| | ||\-+++<-+-++-+-++++--++---+--+-++--+-++----++++++--+-++-++++-+++++++++--+/||  |   |||  | | |  ||  || | || |x
| | || |||| ||  |  ||| ||| ||| |||/++++-+-++--+++-\| || | ||\+--++---+--+-++--+-++----++++++--+-++-++++-+++++++++--+-++--+---+++--+-+-+--++--++-+-/| |x
| | \+-++++-++--+--+++-+++-+++-+/|||||| | ||  ||| || || \-++-+--++---+--+-++--+-+/ /--++++++\ | || |||| |||||||||  | ||  |   |||  | | |  ||  || |  | |x
| |  | ||\+-++--+--+++-+++-+++-+-++++++-+-++--+++-++-++---++-+--++---+--+-++--+-+--+--+++++++-+-++-++/| ||||||||\--+-++--+---+++--+-+-/  ||  || |  | |x
|/+--+-++-+-++--+--+++-+++-+++-+-++++++-+-++--+++-++-++---++-+--++---+--+-++--+-+--+--+++++++-+-++-++\| ||||||||   | ||  |   |||  | |    ||  || |  | |x
|||  | || | ||  \--+++-+++-+++-+-++++/| \-++--+++-++-++---++-+--++---+--+-++--+-+--+--+++++++-+-++-++++-++++++/|   | ||  |   |||  | |    ||  || |  | |x
|||  | || | ||     ||| ||| ||| | |||| |   ||  ||| || ||   || |  \+---+--+-++--+-+--+--++/|||| | || |||| |||||| |   | ||  |   |||  | |    ||  || |  | |x
|||/-+-++-+-++-----+++-+++-+++-+-++++-+---++--+++-++-++---++\|   |   |  | ||  | |  |  || |||| | || |||| |||||| |   | ||  |   |||  | |    ||  || |  | |x
|||| | || | ||     ||| ||| ||| | \+++-+---++--+++-++-++---++++---+---+--+-++--+-+--+--++-++++-+-++-++++-++++++-+---+-++--+---/||  | |    ||  || |  | |x
|||| | || | ||     ||| ||| ||| |  ||| |   ||  ||\-++-++---++++---+---+--+-+/  | |  |  || |||| | || |||| |||||| |   | ||  |    || /+-+----++--++-+--+\|x
|||| | || | ||     ||| ||| ||| \--+++-+---++--++--++-++---+++/   |   |  | |   | |  |  || |||| | || |||| |||||| |   | ||  |    || || |    ||  || |  |||x
|||| | || \-++-----+++-+++-+/|    ||| |   ||  ||  || ||   |||    |/--+--+-+--\| |  |  \+-++++-+-++-/||| |||\++-+---+-++--+----++-++-+----/|  || |  |||x
|||| | ||   ||     ||| ||| \-+----+++-+---++--++--++-++---+/|    ||  |  | |  || |  |   |/++++-+-++--+++-+++-++-+---+-++--+---\|| || |     |  || |  |||x
|||| | ||   ||     ||| |||   |    \++-+---++--++--/| \+---+-+----++--+--+-+--++-+--+---++++++-+-++--+++-+++-++-+---+-++--+---+++-++-+-----+--++-+--/||x
|||| | ||   ||     ||| |||   |     || |   ||  ||   |  |   | |    ||  \--+-+--++-+--+---++++++-+-++--+++-+++-++-+---/ ||  |   ||| || |     |  || |   ||x
|||| | \+---++-----+++-+++---+-----++-+---++--++---+--+---+-+----++-----+-+--++-+--+---++++++-+-++--+++-+++-++-/     ||  |   ||| || |     |  || |   ||x
|||| |  |   ||     ||| |||   |     || |   ||  ||   |  |   | |    ||     | |  || |  |   |||||| | \+--+++-+++-++-------/|  |   ||| || |     |  || |   ||x
|||| |  |   ||     ||| |||   |     || |   ||  |\---+--+---+-+----++-----+-+--++-+--+---++++++-+--+--+++-+++-++--------+--+---+++-++-+-----+--++-+---+/x
|||| |  |   \+-----++/ |||   |     || |   ||  \----+--+---+-+----++-----+-+--++-+--+---++++++-+--+--+++-+/| ||        |  |   ||| || |     |  || |   | x
|||| |  \----+-----++--+++---+-----++-+---/|       \--+---+-+----++-----+-+--++-+--+---++++++-+--+--+++-+-+-+/        \--+---+++-++-/     |  || |   | x
|||| |       |     ||  |||   |     |v |    |    /-----+---+-+----++-----+-+--++-+--+---++++++-+--+--+++-+-+-+----\       |   ||| ||       |  || |   | x
|||| |       |     ||  ||\---+-----++-+----+----+-----+---+-+----++-----+-+--++-+--+---++++++-+--+--+++-+-+-+--<-+-------+---++/ ||       |  || |   | x
|||| |       |     ||  ||    |     || |    |    |     |   | |    ||     | \--++-+--+---++++++-+--+--+++-+-+-+----+-------+---++--++-------+--/| |   | x
|||| |  /----+-----++--++--\ |     || |    |    |     |   | |    ||     |    || |  |   |\++++-+--+--+++-+-+-+----+-------+---/|  ||       |   | |   | x
|||| |  |    |     ||  ||  | |     || |   /+----+-----+---+-+--\ ||     |    || |  |   | |\++-+--+--+++-+-+-+----+-------/    |  ||       |   | |   | x
|||| |  |    |     ||  ||  | |     || |   ||    |     |   | |  | ||     |    || |  |   \-+-++-+--+--+++-+-+-+----+------------+--++-------/   | |   | x
||\+-+--+----+-----++--++--+-+-----++-+-->++----+-----+---+-+--+-++-----+----++-+--+-----+-++-+--+--+++-+-+-/    |            |  ||           | |   | x
|| | \--+----+-----++--++--+-+-----++-+---++----+-----+---+-+--+-++-----+----++-+--+-----+-++-+--/  |||/+-+------+---\        |  ||           | |   | x
|| |    |    |     ||  |\--+-+-----++-+---++----+-----+---+-+--+-++-----+----++-/  |     | || |     ||||| |      |   |        |  ||           | |   | x
|| |    |    |     ||  |   | \-----++-+---++----+-----+---+-+--+-++-----+----++----+-----+-/| |     ||||| |      |   |        |  ||           | |   | x
|| |    |    |     |\--+---+-------++-+---++----+-----+---/ |  | ||     |    ||    |     |  | |     ||||| |      |   |        |  ||           | |   | x
|| |    |    \-----+---/   |       || |   ||    |     |     |  | ||     |    ||    |     |  | |     \++++-+------+---+--------+--+/           | |   | x
|| |    |          \-------+-------+/ |   ||    |     \-----+--+-++-----+----++----+-----+--+-+------++++-+------+---+--------+--+------------/ |   | x
|\-+----+------------------+-------+--+---++----+-----------+--+-++-----+----++----+-----+--+-+------/||| |      |   |        |  |              |   | x
|  |    |                  |       |  \---++----+-----------+--+-++-----+----++----+-----+--+-+-------++/ |      |   |        |  |              |   | x
|  |    |                  |       |      \+----+-----------+--/ |\-----+----/|    |     \--+-+-------/|  |      |   |        |  |              |   | x
|  |    |                  |       |       |    \-----------+----+------+-----+----+--------+-+--------+--+------/   |        |  |              |   | x
|  |    |                  |       |       |                |    |      |     |    |        | |        |  |          |        |  |              |   | x
|  |    \------------------/       \-------+----------------+----+------+-----+----+--------+-+--------+--+----------+--------/  |              |   | x
\--+---------------------------------------+----------------+----+------/     |    \--------/ |        \--+----------/           |              |   | x
   |                                       |                |    |            |               |           |                      |              |   | x
   |                                       \----------------+----+------------+---------------+-----------+----------------------+--------------/   | x
   |                                                        |    |            |               |           |                      \------------------/ x
   \--------------------------------------------------------/    \------------+---------------+-----------/                                           x
                                                                              \---------------/                                                       x";
        private const string ProblemTestInput = @"/->-\        x
|   |  /----\x
| /-+--+-\  |x
| | |  | v  |x
\-+-/  \-+--/x
  \------/   x";


        private const string ProblemTest2Input = @"/>-<\  x
|   |  x
| /<+-\x
| | | vx
\>+</ |x
  |   ^x
  \<->/x";

        public static string SolveProblem1()
        {
            var lines = ProblemInput.SplitToLines().ToList();
            var map = new char[lines[0].Length,lines.Count];
            var carts = new Cart[lines[0].Length,lines.Count];

            for (var y = 0; y < lines.Count; y++)
            {
                var line = lines[y];
                for (var x = 0; x < line.Length; x++)
                {
                    if (line[x] == '>')
                    {
                        carts[x,y] = new Cart { X = x, Y = y, Direction = Heading.E, NextTurn = TurnDirection.L};
                        map[x,y] = '-';
                    }
                    else if (line[x] == 'v')
                    {
                        carts[x,y] = new Cart { X = x, Y = y, Direction = Heading.S, NextTurn = TurnDirection.L};
                        map[x,y] = '|';
                    }
                    else if (line[x] == '<')
                    {
                        carts[x,y] = new Cart { X = x, Y = y, Direction = Heading.W, NextTurn = TurnDirection.L};
                        map[x,y] = '-';
                    }
                    else if (line[x] == '^')
                    {
                        carts[x,y] = new Cart { X = x, Y = y, Direction = Heading.N, NextTurn = TurnDirection.L};
                        map[x,y] = '|';
                    }
                    else
                    {
                        map[x,y] = line[x];
                    }
                }
            }

            var ticks = 0;
            var cartToggle = true;
            while (true)
            {
                for (var y=0; y < lines.Count; y++)
                {
                    for (var x=0; x < lines[0].Length; x++)
                    {
                        if (carts[x,y] != null)
                        {
                            var cart = carts[x,y];
                            if (cart.Toggle == cartToggle)
                            {
                                UpdateCart(carts[x,y], map);

                                if (carts[cart.X, cart.Y] != null)
                                {
                                    return cart.X.ToString() + "," + cart.Y.ToString();
                                }
                                carts[cart.X, cart.Y] = cart;
                                carts[x,y] = null;
                            }
                        }
                    }
                }
                cartToggle = !cartToggle;
                ticks++;
            }
        }

        private static void UpdateCart(Cart cart, char[,] map)
        {
            cart.Toggle = !cart.Toggle;
            switch (cart.Direction)
            {
                case Heading.N:
                    cart.Y -= 1;
                    break;
                case Heading.S:
                    cart.Y += 1;
                    break;
                case Heading.E:
                    cart.X += 1;
                    break;
                case Heading.W:
                    cart.X -= 1;
                    break;
            }

            switch (map[cart.X, cart.Y])
            {
                case '/':
                    switch (cart.Direction)
                    {
                        case Heading.N:
                            cart.Direction = Heading.E;
                            break;
                        case Heading.E:
                            cart.Direction = Heading.N;
                            break;
                        case Heading.S:
                            cart.Direction = Heading.W;
                            break;
                        case Heading.W:
                            cart.Direction = Heading.S;
                            break;
                    }
                    break;
                case '\\':
                    switch (cart.Direction)
                    {
                        case Heading.N:
                            cart.Direction = Heading.W;
                            break;
                        case Heading.E:
                            cart.Direction = Heading.S;
                            break;
                        case Heading.S:
                            cart.Direction = Heading.E;
                            break;
                        case Heading.W:
                            cart.Direction = Heading.N;
                            break;
                    }
                    break;
                case '+':
                    switch (cart.Direction)
                    {
                        case Heading.N:
                            switch (cart.NextTurn)
                            {
                                case TurnDirection.L:
                                    cart.Direction = Heading.W;
                                    cart.NextTurn = TurnDirection.S;
                                    break;
                                case TurnDirection.S:
                                    cart.NextTurn = TurnDirection.R;
                                    break;
                                case TurnDirection.R:
                                    cart.Direction = Heading.E;
                                    cart.NextTurn = TurnDirection.L;
                                    break;
                            }
                            break;
                        case Heading.E:
                            switch (cart.NextTurn)
                            {
                                case TurnDirection.L:
                                    cart.Direction = Heading.N;
                                    cart.NextTurn = TurnDirection.S;
                                    break;
                                case TurnDirection.S:
                                    cart.NextTurn = TurnDirection.R;
                                    break;
                                case TurnDirection.R:
                                    cart.Direction = Heading.S;
                                    cart.NextTurn = TurnDirection.L;
                                    break;
                            }
                            break;
                        case Heading.S:
                            switch (cart.NextTurn)
                            {
                                case TurnDirection.L:
                                    cart.Direction = Heading.E;
                                    cart.NextTurn = TurnDirection.S;
                                    break;
                                case TurnDirection.S:
                                    cart.NextTurn = TurnDirection.R;
                                    break;
                                case TurnDirection.R:
                                    cart.Direction = Heading.W;
                                    cart.NextTurn = TurnDirection.L;
                                    break;
                            }
                            break;
                        case Heading.W:
                            switch (cart.NextTurn)
                            {
                                case TurnDirection.L:
                                    cart.Direction = Heading.S;
                                    cart.NextTurn = TurnDirection.S;
                                    break;
                                case TurnDirection.S:
                                    cart.NextTurn = TurnDirection.R;
                                    break;
                                case TurnDirection.R:
                                    cart.Direction = Heading.N;
                                    cart.NextTurn = TurnDirection.L;
                                    break;
                            }
                            break;
                    }
                    break;
            }
        }

        private enum Heading
        {
            N,
            E,
            S,
            W,
        }

        private enum TurnDirection
        {
            L,
            S,
            R,
        }

        private class Cart
        {
            public int X;
            public int Y;
            public Heading Direction;
            public TurnDirection NextTurn;
            public bool Toggle = true;
        }

        public static string SolveProblem2()
        {
            var lines = ProblemInput.SplitToLines().ToList();
            var map = new char[lines[0].Length,lines.Count];
            var carts = new Cart[lines[0].Length,lines.Count];

            for (var y = 0; y < lines.Count; y++)
            {
                var line = lines[y];
                for (var x = 0; x < line.Length; x++)
                {
                    if (line[x] == '>')
                    {
                        carts[x,y] = new Cart { X = x, Y = y, Direction = Heading.E, NextTurn = TurnDirection.L};
                        map[x,y] = '-';
                    }
                    else if (line[x] == 'v')
                    {
                        carts[x,y] = new Cart { X = x, Y = y, Direction = Heading.S, NextTurn = TurnDirection.L};
                        map[x,y] = '|';
                    }
                    else if (line[x] == '<')
                    {
                        carts[x,y] = new Cart { X = x, Y = y, Direction = Heading.W, NextTurn = TurnDirection.L};
                        map[x,y] = '-';
                    }
                    else if (line[x] == '^')
                    {
                        carts[x,y] = new Cart { X = x, Y = y, Direction = Heading.N, NextTurn = TurnDirection.L};
                        map[x,y] = '|';
                    }
                    else
                    {
                        map[x,y] = line[x];
                    }
                }
            }

            var ticks = 0;
            var cartToggle = true;
            while (true)
            {
                for (var y=0; y < lines.Count; y++)
                {
                    for (var x=0; x < lines[0].Length; x++)
                    {
                        if (carts[x,y] != null)
                        {
                            var cart = carts[x,y];
                            if (cart.Toggle == cartToggle)
                            {
                                UpdateCart(carts[x,y], map);

                                if (carts[cart.X, cart.Y] == null)
                                {
                                    carts[cart.X, cart.Y] = cart;
                                }
                                else
                                {
                                    carts[cart.X, cart.Y] = null;
                                }
                                carts[x,y] = null;
                            }
                        }
                    }
                }

                var cartsLeft = 0;
                var lastX = -1;
                var lastY = -1;
                for (var y=0; y < lines.Count; y++)
                {
                    for (var x=0; x < lines[0].Length; x++)
                    {
                        if (carts[x,y] != null)
                        {
                            cartsLeft++;
                            lastX = x;
                            lastY = y;
                        }

                        if (cartsLeft > 1)
                            break;
                    }
                    if (cartsLeft > 1)
                        break;
                }

                if (cartsLeft == 1)
                {
                    return lastX.ToString() + "," + lastY.ToString();
                }

                cartToggle = !cartToggle;
                ticks++;
            }
        }
    }
}